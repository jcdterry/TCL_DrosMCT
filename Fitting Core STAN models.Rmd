---
title: "Fitting Core STAN models"
author: "Chris Terry"
output: html_document
---


This script fits the core STAN models, both the Gaussian and Count-model cases. 

It also calculates the LOO likelihoods needed for elpd. 

It does not do any subsequent analysis - That is handled in `Main Text Analyses.rmd` or one of the SI documents. 

Assessment of sensitivity to priors is also conducted separately - SI 3.


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(shinystan)
library(knitr)
library(scales)
library(loo)
library(cowplot)
library(igraph)

source('Scripts/GaussianFunctions.R') 
source('Scripts/NegBinFunctions.R') 

d_both <- read_csv('Data/d_both.csv')

species <- c('BIR','PAL', 'PAN', 'PSA', 'SIM', 'SUL')
Num_Draws <- 3000

dir.create('StanFits/')
dir.create('StanModels/')
dir.create('LOO/')
```

# Preparing data

Count models can't deal with the halves that are derived from dividing males+females by two to get the best estimate of the number of pairs (/females).
Instead use 'total count', which is just this times two
```{r}
d_both <- mutate(d_both, ObsCount_Total =  ObsCount_Pairs*2)
d_HS <- filter(d_both, Parasitism =='Safe')
d_HP <- filter(d_both, Parasitism =='Para')

```

# Writing and fitting STAN functions

Using one set of data, can pre-specify ordering of combinations of species.  For each of 750 iterations,  have a separate line, (written with a simple R script pulling in the relevant numbers)

e.g.:

`rs[r_sel] / (1+ N0s[Aii_selection1]* A[Aii_selection2]   + N0s[Aij_selection1] *A0[Aij_selection2]    )`    

Handled by various `WriteStanFunction()` versions

## 1. Separate A and r models

```{r}
Write_BothTreatmentsStanFunction_DoubleA(PreparedData1 = d_HS,
                                         PreparedData2 = d_HP,
                                         'BothTogether_2As',
                                         AlphaLowerBound = TRUE, AlphaSD= 1)
```

```{r}
fit_both_doubleA <- stan( file = 'StanModels/BuiltModel_BothTogether_2As.stan',
                          data = list(N = nrow(d_both), 
                                      y = c(d_both$ObsGrRate)) , 
                          chains = 4, seed = 1,
                          cores = 2, iter = Num_Draws)

save(fit_both_doubleA, file = 'StanFits/fit_both_doubleA')
```

## 2. Single A, separate R

```{r}
Write_BothTreatmentsStanFunction_SingleA(PreparedData1 = d_HS,
                                         PreparedData2 = d_HP,
                                         'BothTogether_singleA',
                                         AlphaLowerBound = TRUE, AlphaSD= 1)
```

```{r}
fit_both_singleA <- stan( file = 'StanModels/BuiltModel_BothTogether_singleA.stan',
                          data = list(N = nrow(d_both), 
                                      y = c(d_both$ObsGrRate)) , 
                          chains = 4,  seed = 1,
                          cores = 2, iter = Num_Draws)

save(fit_both_singleA, file = 'StanFits/fit_both_singleA')
```

## 3. Single A and single r

```{r}
Write_BothTreatmentsStanFunction_SingleSetRandA(PreparedData1 = d_HS,
                                                PreparedData2 = d_HP,
                                                'Comb_RandA',
                                         AlphaLowerBound = TRUE, AlphaSD= 1)
```

```{r}
fit_both_Comb_RandA <- stan( file = 'StanModels/BuiltModel_Comb_RandA.stan',
                             data = list(N = nrow(d_both), 
                                         y = c(d_both$ObsGrRate)) , 
                             chains = 4,  seed = 1,
                             cores = 2, iter = Num_Draws)

save(fit_both_Comb_RandA, file = 'StanFits/fit_both_Comb_RandA')
```

# Cross-validation

```{r}
load('StanFits/fit_both_singleA')
load('StanFits/fit_both_doubleA')
load('StanFits/fit_both_Comb_RandA')
```

```{r}
singleA_loo   <-loo(fit_both_singleA)
doubleA_loo   <-loo(fit_both_doubleA)
Comb_RandA_loo<-loo(fit_both_Comb_RandA)
save(singleA_loo, file='LOO/singleA_loo')
save(doubleA_loo, file='LOO/doubleA_loo')
save(Comb_RandA_loo, file='LOO/Comb_RandA_loo')
```


# Raw Count (negative binomial) Model fitting

This approach uses the raw count data. This allows the variability in small counts to be more appropriately modeled, but does not adjust for variable generation times.

## 1. Separate A and r models, but combined 


```{r}
Write_Stan_NegB_DoubleA(PreparedData1 = d_HS,
                        PreparedData2 = d_HP,
                        'NegB_BothTogether_2As')

fit_both_doubleA_NegB <- stan(file = 'StanModels/BuiltModel_NegB_BothTogether_2As.stan',
                          data = list(N = nrow(d_both), 
                                      y = c(d_both$ObsCount_Total)) , 
                          chains = 4, seed = 1,
                          cores = 2, iter = Num_Draws)

save(fit_both_doubleA_NegB, file = 'StanFits/fit_both_doubleA_NegB')
```

## 2. Single A, separate R

```{r}
Write_Stan_NegB_SingleA(PreparedData1 = d_HS,
                        PreparedData2 = d_HP,
                        'NegB_BothTogether_singleA')

fit_both_singleA_NegB <- stan( file = 'StanModels/BuiltModel_NegB_BothTogether_singleA.stan',
                          data = list(N = nrow(d_both), 
                                      y = c(d_both$ObsCount_Total)) , 
                          chains = 4,  seed = 1,
                          cores = 2, iter = Num_Draws)

save(fit_both_singleA_NegB, file = 'StanFits/fit_both_singleA_NegB')
```


```{r}
singleA_loo_NegB   <-loo(fit_both_singleA_NegB)
doubleA_loo_NegB   <-loo(fit_both_doubleA_NegB)

save(singleA_loo_NegB, file='LOO/singleA_loo_NegB')
save(doubleA_loo_NegB, file='LOO/doubleA_loo_NegB')
```


# Raw Count (Poisson) Model fitting

This approach uses the raw count data. This allows the variability in small counts to be more appropriately modeled, but does not adjust for variable generation times.

## 1. Separate A and r models, but combined 

```{r}

Write_Stan_Pois_DoubleA(PreparedData1 = d_HS,
                        PreparedData2 = d_HP,
                        'Pois_BothTogether_2As')

fit_both_doubleA_Pois <- stan( file = 'StanModels/BuiltModel_Pois_BothTogether_2As.stan',
                          data = list(N = nrow(d_both), 
                                      y = c(d_both$ObsCount_Total)) , 
                          chains = 4, seed = 1,
                          cores = 2, iter = Num_Draws)

save(fit_both_doubleA_Pois, file = 'StanFits/fit_both_doubleA_Pois')
```

## 2. Single A, separate R

```{r}

Write_Stan_Pois_SingleA(PreparedData1 = d_HS,
                        PreparedData2 = d_HP,
                        'Pois_BothTogether_singleA')

fit_both_singleA_Pois <- stan( file = 'StanModels/BuiltModel_Pois_BothTogether_singleA.stan',
                          data = list(N = nrow(d_both), 
                                      y = c(d_both$ObsCount_Total)) , 
                          chains = 4,  seed = 1,
                          cores = 2, iter = Num_Draws)

save(fit_both_singleA_Pois, file = 'StanFits/fit_both_singleA_Pois')
```

## 3. Single A and single r

```{r}
Write_Stan_Pois_SingleSetRandA(PreparedData1 = d_HS,
                               PreparedData2 = d_HP,
                               'Pois_Comb_RandA')


fit_both_Comb_RandA_Pois <- stan( file = 'StanModels/BuiltModel_Pois_Comb_RandA.stan',
                             data = list(N = nrow(d_both), 
                                         y = c(d_both$ObsCount_Total)) , 
                             chains = 4,  seed = 1,
                             cores = 2, iter = Num_Draws)

save(fit_both_Comb_RandA_Pois, file = 'StanFits/fit_both_Comb_RandA_Pois')
```

```{r}
load('StanFits/fit_both_singleA_Pois')
load('StanFits/fit_both_doubleA_Pois')
load('StanFits/fit_both_Comb_RandA_Pois')

```

```{r}
singleA_loo_Pois   <-loo(fit_both_singleA_Pois)
doubleA_loo_Pois   <-loo(fit_both_doubleA_Pois)
Comb_RandA_loo_Pois<-loo(fit_both_Comb_RandA_Pois)
save(singleA_loo_Pois, file='LOO/singleA_loo_Pois')
save(doubleA_loo_Pois, file='LOO/doubleA_loo_Pois')
save(Comb_RandA_loo_Pois, file='LOO/Comb_RandA_loo_Pois')
```

